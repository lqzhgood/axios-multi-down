(function(f,d){typeof exports=="object"&&typeof module<"u"?module.exports=d():typeof define=="function"&&define.amd?define(d):(f=typeof globalThis<"u"?globalThis:f||self,f.AxiosMultiDown=d())})(this,function(){"use strict";var f=(t=>(t.HEAD="head",t.SELF="self",t))(f||{}),d=(t=>(t[t.NODE=0]="NODE",t[t.Browser=1]="Browser",t))(d||{});const w={max:3,blockSize:"10M",testMethod:"head"},D=(()=>{if(typeof window=="object")return d.Browser;if(Object.prototype.toString.call(process)==="[object process]")return d.NODE})();function k(t,n){if(t<=0||n<=0)throw console.log("contentLength",t),console.log("blockSize",n),new Error("参数错误");const e=[],r=Math.ceil(t/n);for(let s=0;s<r;s++)s!==r-1?e.push({s:n*s,e:n*(s+1)-1,i:s}):e.push({s:n*s,e:t-1,i:s});return e}function A(t){const n=t.reduce((s,o)=>s+o.length,0),e=new Uint8Array(n);let r=0;return t.forEach(s=>{e.set(s,r),r+=s.length}),e}function M(t){if(typeof t.max!="number")throw new Error(`downConfig.max must be number, got ${t.max}`);if(t.blockSize=x(t.blockSize),![f.HEAD,f.SELF].includes(t.testMethod))throw new Error(`downConfig.testMethod must be head | self , got ${t.testMethod}`);return t}function x(t){if(typeof t=="number"){if(t<=0)throw new Error(`downConfig.blockSize number must be > 0 , got ${t}`);return t}if(/^\d+K$/.test(t))return Number(t.match(/\d+/)[0])*1024;if(/^\d+M$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024;if(/^\d+G$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024*1024;if(/^\d+T$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024*1024*1024;throw new Error(`downConfig.blockSize string only supported K,M,G,T, got ${t}`)}class N{constructor(){this.events={}}on(n,e){this.events[n]||(this.events[n]=[]),this.events[n].push(e)}off(n,e){if(this.events[n]){const r=this.events[n].indexOf(e);r!==-1&&this.events[n].splice(r,1)}}emit(n,...e){if(this.events[n])for(const r of this.events[n])r(...e)}}function y(t,n=w){return t.down=async function(e,r,s){var p;let o={},u={...w,...n};arguments.length===1&&(typeof e=="string"?o={url:e}:o=e),arguments.length===2&&(typeof e=="string"?o={...r,url:e}:(o=e,u={...u,...r})),arguments.length===3&&(o={...r,url:e},u={...u,...s});const a=M(u),[h,m]=await $(t,a,o);if(!h||!m)return await b(t,o,a);{const l=k(m,a.blockSize);a.max=a.max<=l.length?a.max:l.length,(p=a.emitter)==null||p.emit("preDown",l,a);let i;return a.max===1?i=await b(t,o,a):i=await v(t,o,a,l,m),i}},t}async function $(t,n,e){const{testMethod:r}=n,s={...e.headers,Range:"bytes=0-0"},o={...e,headers:s};let u;return r===f.HEAD||D===d.Browser?u=await T(t,o):u=await j(t,o),u?B(u.headers):[!1,null]}function B(t){const n=t["accept-ranges"]==="bytes",e=t["content-range"],r=Number(t["content-length"]),s=n||!!e||r===1,o=e?Number(e.split("/")[1]):r;return[s,o]}function T(t,n){return new Promise(e=>{t({...n,method:f.HEAD}).then(r=>{e(r)}).catch(r=>{e(r.response||null)})})}function j(t,n){return new Promise(e=>{const r=new AbortController;t({...n,signal:r.signal,responseType:"stream"}).then(s=>{s.data.on("data",o=>{e(s),r.abort()})}).catch(s=>{e(s.response||null)})})}async function b(t,n,e){var a,h;const r=await t(n),s={s:0,e:r.headers["content-length"]-1,i:0,resp:r},o=[s];return(a=e.emitter)==null||a.emit("data",s,o,e),(h=e.emitter)==null||h.emit("end",o,e),{...r,isMulti:!1,downConfig:e,queue:o}}function v(t,n,e,r,s){return new Promise((o,u)=>{let a;const h=n.responseType||"json";let m=0,p=0;const l=r.map(i=>()=>new Promise(H=>{m++,p++;const K={...(n==null?void 0:n.headers)||{},Range:`bytes=${i.s}-${i.e}`};t({...n,headers:K,responseType:"arraybuffer"}).then(c=>{var g,E;if(c.data=c.data instanceof ArrayBuffer?new Uint8Array(c.data):c.data,i.resp=c,(g=e.emitter)==null||g.emit("data",i,r,e),a||(a={...c,isMulti:!0,downConfig:e,queue:r}),m===l.length&&p===1){switch((E=e.emitter)==null||E.emit("end",r,e),c.data=A(r.map(S=>S.resp.data)),h){case"json":try{c.data=new TextDecoder("utf-8").decode(c.data),c.data=JSON.parse(c.data),c.config.responseType=h}catch{}break;case"text":c.data=new TextDecoder("utf-8").decode(c.data),c.config.responseType=h}a={...c,isMulti:!0,downConfig:e,queue:r},a.status=200,a.statusText="OK",a.headers["content-type"]=s,o(a)}H(a)}).catch(c=>{u(c)}).finally(()=>{p--,m<l.length&&(p<e.max||e.max===1)&&l[m]()})}));for(let i=0;i<e.max;i++)l[i]()})}return y.EventEmitter=N,y});
