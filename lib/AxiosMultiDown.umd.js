(function(p,h){typeof exports=="object"&&typeof module<"u"?module.exports=h():typeof define=="function"&&define.amd?define(h):(p=typeof globalThis<"u"?globalThis:p||self,p.AxiosMultiDown=h())})(this,function(){"use strict";var p=(t=>(t.RETURN="RETURN",t.WAIT="WAIT",t))(p||{}),h=(t=>(t.HEAD="HEAD",t.SELF="SELF",t))(h||{}),w=(t=>(t[t.NODE=0]="NODE",t[t.Browser=1]="Browser",t))(w||{});const D={max:3,blockSize:"10M",testMethod:"HEAD",maxRetries:3,retryInterval:1e3,errMode:"RETURN"},T=(()=>{if(typeof window=="object")return w.Browser;if(Object.prototype.toString.call(process)==="[object process]")return w.NODE})();function M(t,r){if(t<=0||r<=0)throw console.log("contentLength",t),console.log("blockSize",r),new Error("参数错误");const e=[],n=Math.ceil(t/r);for(let s=0;s<n;s++)s!==n-1?e.push({s:r*s,e:r*(s+1)-1,i:s,retryCount:0}):e.push({s:r*s,e:t-1,i:s,retryCount:0});return e}function x(t){const r=t.reduce((s,o)=>s+o.length,0),e=new Uint8Array(r);let n=0;return t.forEach(s=>{e.set(s,n),n+=s.length}),e}function R(t){if(typeof t.max!="number")throw new Error(`downConfig.max must be number, got ${t.max}`);if(t.blockSize=k(t.blockSize),![h.HEAD,h.SELF].includes(t.testMethod))throw new Error(`downConfig.testMethod must be head | self , got ${t.testMethod}`);return t}function k(t){if(typeof t=="number"){if(t<=0)throw new Error(`downConfig.blockSize number must be > 0 , got ${t}`);return t}if(/^\d+K$/.test(t))return Number(t.match(/\d+/)[0])*1024;if(/^\d+M$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024;if(/^\d+G$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024*1024;if(/^\d+T$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024*1024*1024;throw new Error(`downConfig.blockSize string only supported K,M,G,T, got ${t}`)}function A(t){return t.charAt(0).toUpperCase()+t.slice(1)}class H{constructor(){this.events={}}on(r,e){this.events[r]||(this.events[r]=[]),this.events[r].push(e)}once(r,e){const n=(...s)=>{this.off(r,n),e(...s)};this.on(r,n)}off(r,e){if(this.events[r]){const n=this.events[r].indexOf(e);n!==-1&&this.events[r].splice(n,1)}}emit(r,...e){if(this.events[r])for(const n of this.events[r])n(...e)}}function b(t,r=D){return t.down=async function(e,n,s){let o={},a={...D,...r};arguments.length===1&&(typeof e=="string"?o={url:e}:o=e),arguments.length===2&&(typeof e=="string"?o={...n,url:e}:(o=e,a={...a,...n})),arguments.length===3&&(o={...n,url:e},a={...a,...s});const c=R(a),[y,u]=await $(t,c,o);if(!y||!u)return await S(t,o,c);{const l=M(u,c.blockSize);c.max=c.max<=l.length?c.max:l.length,d(c,"preDown",l,c);let i;return c.max===1?i=await S(t,o,c):i=await I(t,o,c,l,u),i}},t}async function $(t,r,e){const{testMethod:n}=r,s={...e.headers,Range:"bytes=0-0"},o={...e,headers:s};let a;return n===h.HEAD||T===w.Browser?a=await v(t,o):a=await B(t,o),a?g(a.headers):[!1,null]}function g(t){const r=t["accept-ranges"]==="bytes",e=t["content-range"],n=Number(t["content-length"]),s=r||!!e||n===1,o=e?Number(e.split("/")[1]):n;return[s,o]}function v(t,r){return new Promise(e=>{t({...r,method:h.HEAD}).then(n=>{e(n)}).catch(n=>{e(n.response||null)})})}function B(t,r){return new Promise(e=>{const n=new AbortController;t({...r,signal:n.signal,responseType:"stream"}).then(s=>{s.data.on("data",o=>{e(s),n.abort()})}).catch(s=>{e(s.response||null)})})}function S(t,r,e){const n={s:0,e:0,i:0,retryCount:0},s=[n];let o={isMulti:!1,downConfig:e,queue:s};return new Promise((a,c)=>{function y(){return t(r).then(u=>(n.isDown=!0,n.e=u.headers["content-length"]-1,n.resp=u,d(e,"data",n,s,e),d(e,"end",s,e),o={...u,...o},a(o),o)).catch(u=>(n.isDown=!1,d(e,"blockError",n,s,e),n.retryCount<e.maxRetries?(n.retryCount++,setTimeout(()=>{y()},e.retryInterval)):(u.response&&(o={...u.response,downResponse:o}),u.downResponse=o,e.errMode!==p.WAIT&&c(u),d(e,"finishErr",s.filter(l=>!l.resp),s,e)),o))}n.down=y,y()})}function I(t,r,e,n,s){return new Promise((o,a)=>{let c;const y=r.responseType||"json";let u=0,l=0;n.forEach(i=>{const L=(F=!1)=>new Promise(N=>{F||(u++,l++),i.isDown=!0;const K={...(r==null?void 0:r.headers)||{},Range:`bytes=${i.s}-${i.e}`};t({...r,headers:K,responseType:"arraybuffer"}).then(f=>{f.data=f.data instanceof ArrayBuffer?new Uint8Array(f.data):f.data,i.resp=f,c||(c={...f,isMulti:!0,downConfig:e,queue:n}),i.i===n.length-1&&(c={...f,isMulti:!0,downConfig:e,queue:n}),d(e,"data",i,n,e),N(c)}).catch(f=>(d(e,"blockError",i,n,e),N(c),f)).then(f=>{if(l--,i.isDown=!1,l>=e.max)return;if(u<n.length){n[u].down();return}const E=n.find(m=>!m.resp&&!m.isDown&&m.retryCount<e.maxRetries);if(E){l++,E.retryCount++,E.isDown=!0,setTimeout(()=>{E.down(!0)},e.retryInterval);return}if(l===0){if(n.filter(m=>!m.resp).length!==0){e.errMode!==p.WAIT&&(f.downResponse=c,a(f)),d(e,"finishErr",n.filter(m=>!m.resp),n,e);return}d(e,"end",n,e),c.data=x(n.map(m=>m.resp.data)),j(c,y),c.status=200,c.statusText="OK",c.headers["content-type"]=s,o(c)}})});i.down=L});for(let i=0;i<e.max;i++)n[i].down()})}function d(t,r,...e){var c;(c=t.emitter)==null||c.emit(r,...e);const n="on"+A(r),s=t[n];s&&s(...e);const o="once"+A(r),a=t[o];a&&a(...e),t[o]=void 0}function j(t,r){switch(r){case"json":try{t.data=new TextDecoder("utf-8").decode(t.data),t.data=JSON.parse(t.data),t.config.responseType=r}catch{}break;case"text":t.data=new TextDecoder("utf-8").decode(t.data),t.config.responseType=r}return t}function W(t,r){t=t.filter(e=>!e.resp);for(let e=0;e<t.length;e++){const n=t[e];n.retryCount=0}for(let e=0;e<Math.min(r.max,t.length);e++)t[e].down()}return b.EventEmitter=H,b.RetryQueue=W,b.const={ERROR_MODE:p,TEST_METHOD:h},b});
