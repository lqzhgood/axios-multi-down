(function(l,f){typeof exports=="object"&&typeof module<"u"?module.exports=f():typeof define=="function"&&define.amd?define(f):(l=typeof globalThis<"u"?globalThis:l||self,l.AxiosMultiDown=f())})(this,function(){"use strict";var l=(t=>(t.HEAD="head",t.SELF="self",t))(l||{}),f=(t=>(t[t.NODE=0]="NODE",t[t.Browser=1]="Browser",t))(f||{});const p={max:3,blockSize:"10M",testMethod:"head"},S=(()=>{if(typeof window=="object")return f.Browser;if(Object.prototype.toString.call(process)==="[object process]")return f.NODE})();function k(t,n){if(t<=0||n<=0)throw new Error("参数错误");const e=[],r=Math.ceil(t/n);for(let s=0;s<r;s++)s!==r-1?e.push({s:n*s,e:n*(s+1)-1,i:s}):e.push({s:n*s,e:t-1,i:s});return e}function A(t){const n=t.reduce((s,o)=>s+o.length,0);let e=new Uint8Array(n),r=0;return t.forEach(s=>{e.set(s,r),r+=s.length}),e}function M(t){if(typeof t.max!="number")throw new Error(`downConfig.max must be number, got ${t.max}`);if(t.blockSize=x(t.blockSize),![l.HEAD,l.SELF].includes(t.testMethod))throw new Error(`downConfig.testMethod must be head | self , got ${t.testMethod}`);return t}function x(t){if(typeof t=="number"){if(t<=0)throw new Error(`downConfig.blockSize number must be > 0 , got ${t}`);return t}if(/^\d+K$/.test(t))return Number(t.match(/\d+/)[0])*1024;if(/^\d+M$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024;if(/^\d+G$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024*1024;if(/^\d+T$/.test(t))return Number(t.match(/\d+/)[0])*1024*1024*1024*1024;throw new Error(`downConfig.blockSize string only supported K,M,G,T, got ${t}`)}class N{constructor(){this.events={}}on(n,e){this.events[n]||(this.events[n]=[]),this.events[n].push(e)}off(n,e){if(this.events[n]){const r=this.events[n].indexOf(e);r!==-1&&this.events[n].splice(r,1)}}emit(n,...e){if(this.events[n])for(const r of this.events[n])r(...e)}}function y(t,n=p){return t.down=async function(e,r,s){let o={},u={...p,...n};arguments.length===1&&(typeof e=="string"?o={url:e}:o=e),arguments.length===2&&(typeof e=="string"?o={...r,url:e}:(o=e,u={...u,...r})),arguments.length===3&&(o={...r,url:e},u={...u,...s});const a=M(u),i=await $(t,a,o);if(i){const d=k(i,a.blockSize);a.max=a.max<=d.length?a.max:d.length;let h;return a.max===1?h=await b(t,o,a):h=await T(t,o,a,d,i),h}else return await b(t,o,a)},t}async function $(t,n,e){const{testMethod:r}=n,s={...e.headers,Range:"bytes=0-0"},o={...e,headers:s};let u=null;return r===l.HEAD||S===f.Browser?u=await B(t,o):u=await j(t,o),u}function B(t,n){return new Promise(e=>{t({...n,method:l.HEAD}).then(r=>{const s=r.headers["accept-ranges"]==="bytes",o=r.headers["content-range"];e(s&&o?Number(o.split("/")[1]):null)}).catch(()=>{e(null)})})}function j(t,n){return new Promise(e=>{const r=new AbortController;t({...n,signal:r.signal,responseType:"stream"}).then(s=>{s.data.on("data",o=>{const u=s.headers["content-range"];s.headers["content-length"]==1&&u?e(Number(u.split("/")[1])):e(null),r.abort()})}).catch(()=>{e(null)})})}async function b(t,n,e){var a,i;const r=await t(n),s={s:0,e:r.headers["content-length"]-1,i:0,resp:r},o=[s];return(a=e.emitter)==null||a.emit("data",s,o),(i=e.emitter)==null||i.emit("end"),{...r,isMulti:!1,downConfig:e,queue:o}}function T(t,n,e,r,s){return new Promise((o,u)=>{let a;const i=n.responseType||"json";let d=0,h=0;const w=r.map(m=>()=>new Promise((v,K)=>{d++,h++;const H={...(n==null?void 0:n.headers)||{},Range:`bytes=${m.s}-${m.e}`};t({...n,headers:H,responseType:"arraybuffer"}).then(c=>{var g,E;if(c.data=c.data instanceof ArrayBuffer?new Uint8Array(c.data):c.data,m.resp=c,(g=e.emitter)==null||g.emit("data",m,r),a||(a={...c,isMulti:!0,downConfig:e,queue:r}),d===w.length&&h===1){switch((E=e.emitter)==null||E.emit("end"),c.data=A(r.map(D=>D.resp.data)),i){case"json":try{c.data=new TextDecoder("utf-8").decode(c.data),c.data=JSON.parse(c.data),c.config.responseType=i}catch{}break;case"text":c.data=new TextDecoder("utf-8").decode(c.data),c.config.responseType=i}a={...c,isMulti:!0,downConfig:e,queue:r},a.status=200,a.statusText="OK",a.headers["content-type"]=s,o(a)}v(a)}).catch(c=>{u(c)}).finally(()=>{h--,d<w.length&&(h<e.max||e.max===1)&&w[d]()})}));for(let m=0;m<e.max;m++)w[m]()})}return y.EventEmitter=N,y});
